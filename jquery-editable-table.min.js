$.fn.editableTable=function(e){let t;e=$.extend({},{cloneProperties:["padding","padding-top","padding-bottom","padding-left","padding-right","text-align","font","font-size","font-family","font-weight","border","border-top","border-bottom","border-left","border-right","color","background-color","border-radius"],columns:[]},e);let n,o,r="error",a=37,i=38,d=39,l=40,s=$(this),c=s.parent().find("input[table-editor-input]");function f(t){(o=s.find("td:focus")).length&&(n.val(o.text()).removeClass(r).show().offset(o.offset()).css(o.css(e.cloneProperties)).width(o.width()).height(o.height()).focus(),t&&n.select())}function u(){let e,t=n.val(),a=$.Event("change");if(o.text()===t||n.hasClass(r))return!0;e=o.html(),o.text(t).trigger(a,t),!1===a.result&&o.html(e)}function h(e,t){return t===d?e.next("td"):t===a?e.prev("td"):t===i?e.parent().prev().children().eq(e.index()):t===l?e.parent().next().children().eq(e.index()):[]}return(n=c.length?c.first():$("<input>")).attr("table-editor-input","").css("position","absolute").hide().appendTo(s.parent()),n.blur(function(){u(),n.hide()}),n.keydown(function(e){if(13===e.which)u(),n.hide(),o.focus(),e.preventDefault(),e.stopPropagation();else if(27===e.which)n.val(o.text()),e.preventDefault(),e.stopPropagation(),n.hide(),o.focus();else if(9===e.which)o.focus();else if(this.selectionEnd-this.selectionStart===this.value.length){let t=h(o,e.which);t.length>0&&(t.focus(),e.preventDefault(),e.stopPropagation())}}),n.on("input paste",function(){let e=$.Event("validate");o.trigger(e,n.val()),void 0!==e.result&&(!1===e.result?n.addClass(r):n.removeClass(r))}),s.on("click keypress dblclick",f).css("cursor","pointer").keydown(function(e){let t=!0,n=h($(e.target),e.which);n.length>0?n.focus():13===e.which?f(!1):17===e.which||91===e.which||93===e.which?(f(!0),t=!1):t=!1,t&&(e.stopPropagation(),e.preventDefault())}),s.find("td").prop("tabindex",1),$(window).on("resize",function(){n.is(":visible")&&n.offset(o.offset()).width(o.width()).height(o.height())}),$("table td").on("validate",function(n,o){let r=$(n.currentTarget).index(),a=e.columns[r],i=t.getData({convert:!1});return a.isValid&&a.isValid(o,i)}),$("table td").on("change",function(t,n){let o=$(this),r=$(t.currentTarget).index(),a=e.columns[r];return a.removeRowIfCleared&&""==n&&o.parent("tr").remove(),"function"==typeof a.afterChange&&a.afterChange(n,o),!0}),t={getData:function(t){t=$.extend({},{convert:!0},t);let n=[];return s.find("tbody tr").toArray().forEach(o=>{let r={};$(o).find("td").toArray().forEach(n=>{let o=e.columns[$(n).index()],a=$(n).text(),i=$(n).attr("data-is-null");void 0!==i&&!1!==i&&(a=null),t.convert&&"function"==typeof o.convertOut&&(a=o.convertOut(a)),r[o.name]=a}),n.push(r)}),n},addRow:function(t){let n=$("<tr></tr>");if(null!=t){let o=Object.keys(t),r=[];o.forEach(n=>{let o=e.columns.filter(e=>e.name===n);o.length&&(o=o[0],r.push({order:o.index,value:t[n],prop:n,def:o}))}),r.sort((e,t)=>e.order-t.order).forEach((t,o)=>{let r;r=null!==t.value?$(`<td>${t.value}</td>`):$("<td data-is-null></td>"),void 0!==t.def.classes&&t.def.classes.length&&t.def.classes.forEach(e=>r.addClass(e)),void 0!==t.def.style&&t.def.style.length&&r.attr("style",r.attr("style")+"; "+t.def.style);let a=e.columns.filter(e=>e.name===t.prop)[0];"function"==typeof a.afterAdd&&a.afterAdd(t.value,r),n.append(r)})}else n=$("<tr></tr>"),activeOptions.columns.forEach(e=>{n.append("<td></td>")});let o=s.find("tbody tr:last");o.length>0?o.after(n):s.find("tbody").append(n),$(s).editableTable(e)},clear:function(){s.find("tbody tr").remove()},setData:function(e){e&&(this.clear(),e.forEach(e=>{this.addRow(e)}))}}};let backgroundColorFromValue=function(e,t){$(t).removeClass("good").removeClass("medium").removeClass("bad"),e>0&&e<=3?$(t).addClass("good"):e>3&&e<=6?$(t).addClass("medium"):e>6&&$(t).addClass("bad")},config={columns:[{index:0,name:"id"},{index:1,name:"string",removeRowIfCleared:!0},{index:2,name:"number",classes:["text-center"],style:"border-radius: 4px;",convertOut:e=>parseInt(e),isValid:(e,t)=>(e=parseInt(e),!isNaN(e)&&Number.isInteger(e)),afterAdd:(e,t)=>{backgroundColorFromValue(e,t)},afterChange:(e,t)=>{backgroundColorFromValue(e,t)}}]};
