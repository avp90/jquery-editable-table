$.fn.editableTable=function(t){let e;t=$.extend({},{cloneProperties:["padding","padding-top","padding-bottom","padding-left","padding-right","text-align","font","font-size","font-family","font-weight","border","border-top","border-bottom","border-left","border-right","color","background-color","border-radius"],columns:[]},t);let n,o,r="error",i=37,l=38,a=39,d=40,s=$(this),f=s.parent().find("input[table-editor-input]");function c(e){(o=s.find("td:focus")).length&&(n.val(o.text()).removeClass(r).show().offset(o.offset()).css(o.css(t.cloneProperties)).width(o.width()).height(o.height()).focus(),e&&n.select())}function h(){let t,e=n.val(),i=$.Event("change");if(o.text()===e||n.hasClass(r))return!0;t=o.html(),o.text(e).trigger(i,e),!1===i.result&&o.html(t)}function u(t,e){return e===a?t.next("td"):e===i?t.prev("td"):e===l?t.parent().prev().children().eq(t.index()):e===d?t.parent().next().children().eq(t.index()):[]}return(n=f.length?f.first():$("<input>")).attr("table-editor-input","").css("position","absolute").hide().appendTo(s.parent()),n.blur(function(){h(),n.hide()}),n.keydown(function(t){if(13===t.which)h(),n.hide(),o.focus(),t.preventDefault(),t.stopPropagation();else if(27===t.which)n.val(o.text()),t.preventDefault(),t.stopPropagation(),n.hide(),o.focus();else if(9===t.which)o.focus();else if(this.selectionEnd-this.selectionStart===this.value.length){let e=u(o,t.which);e.length>0&&(e.focus(),t.preventDefault(),t.stopPropagation())}}),n.on("input paste",function(){let t=$.Event("validate");o.trigger(t,n.val()),void 0!==t.result&&(!1===t.result?n.addClass(r):n.removeClass(r))}),s.on("click keypress dblclick",c).css("cursor","pointer").keydown(function(t){let e=!0,n=u($(t.target),t.which);n.length>0?n.focus():13===t.which?c(!1):17===t.which||91===t.which||93===t.which?(c(!0),e=!1):e=!1,e&&(t.stopPropagation(),t.preventDefault())}),s.find("td").prop("tabindex",1),$(window).on("resize",function(){n.is(":visible")&&n.offset(o.offset()).width(o.width()).height(o.height())}),$("table td").on("validate",function(n,o){let r=$(n.currentTarget).index(),i=t.columns[r],l=e.getData({convert:!1});return i.isValid&&i.isValid(o,l)}),$("table td").on("change",function(e,n){let o=$(this),r=$(e.currentTarget).index(),i=t.columns[r];return i.removeRowIfCleared&&""==n&&o.parent("tr").remove(),"function"==typeof i.afterChange&&i.afterChange(n,o),!0}),e={getData:function(e){e=$.extend({},{convert:!0},e);let n=[];return s.find("tbody tr").toArray().forEach(o=>{let r={};$(o).find("td").toArray().forEach(n=>{let o=t.columns[$(n).index()],i=$(n).text(),l=$(n).attr("data-is-null");void 0!==l&&!1!==l&&(i=null),e.convert&&"function"==typeof o.convertOut&&(i=o.convertOut(i)),r[o.name]=i}),n.push(r)}),n},addRow:function(e){let n=$("<tr></tr>");if(null!=e){let o=Object.keys(e),r=[];o.forEach(n=>{let o=t.columns.filter(t=>t.name===n);o.length&&(o=o[0],r.push({order:o.index,value:e[n],prop:n,def:o}))}),r.sort((t,e)=>t.order-e.order).forEach((e,o)=>{let r;r=null!==e.value?$(`<td>${e.value}</td>`):$("<td data-is-null></td>"),void 0!==e.def.classes&&e.def.classes.length&&e.def.classes.forEach(t=>r.addClass(t)),void 0!==e.def.style&&e.def.style.length&&r.attr("style",r.attr("style")+"; "+e.def.style);let i=t.columns.filter(t=>t.name===e.prop)[0];"function"==typeof i.afterAdd&&i.afterAdd(e.value,r),n.append(r)})}else n=$("<tr></tr>"),activeOptions.columns.forEach(t=>{n.append("<td></td>")});let o=s.find("tbody tr:last");o.length>0?o.after(n):s.find("tbody").append(n),$(s).editableTable(t)},clear:function(){s.find("tbody tr").remove()},setData:function(t){t&&(this.clear(),t.forEach(t=>{this.addRow(t)}))}}};
