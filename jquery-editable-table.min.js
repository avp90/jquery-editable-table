$.fn.editableTable=function(options){let defaultOptions={cloneProperties:['padding','padding-top','padding-bottom','padding-left','padding-right','text-align','font','font-size','font-family','font-weight','border','border-top','border-bottom','border-left','border-right','color','background-color','border-radius'],columns:[]}
options=$.extend({},defaultOptions,options);let _instance;let errorClass='error';let identifierAttribute='table-editor-input';let ARROW_LEFT=37,ARROW_UP=38,ARROW_RIGHT=39,ARROW_DOWN=40,ENTER=13,ESC=27,TAB=9,CONTROL=17,LEFT_WINDOWS=91,SELECT_KEY=93;let element=$(this);element.find('th').show();options.columns.forEach((col,i)=>{if(col.isHidden!==undefined&&col.isHidden)element.find('th').eq(i).hide()});let editor;let existingEditor=element.parent().find(`input[${identifierAttribute}]`);if(existingEditor.length){editor=existingEditor.first()}else{editor=$('<input>')}
editor.attr(identifierAttribute,'').css('position','absolute').hide().appendTo(element.parent());let activeCell;function showEditor(select){activeCell=element.find('td:focus');if(activeCell.length){editor.val(activeCell.text()).removeClass(errorClass).show().offset(activeCell.offset()).css(activeCell.css(options.cloneProperties)).width(activeCell.width()).height(activeCell.height()).focus();if(select){editor.select()}}};function setActiveText(){let text=editor.val(),evt=$.Event('change'),originalContent;if(activeCell.text()===text||editor.hasClass(errorClass)){return!0}
originalContent=activeCell.html();activeCell.text(text).trigger(evt,text);if(evt.result===!1){activeCell.html(originalContent)}};function handleMovement(element,keycode){if(keycode===ARROW_RIGHT){return element.next('td')}else if(keycode===ARROW_LEFT){return element.prev('td')}else if(keycode===ARROW_UP){return element.parent().prev().children().eq(element.index())}else if(keycode===ARROW_DOWN){return element.parent().next().children().eq(element.index())}
return[]};editor.blur(function(){setActiveText();editor.hide()});editor.keydown(function(e){if(e.which===ENTER){setActiveText();editor.hide();activeCell.focus();e.preventDefault();e.stopPropagation()}else if(e.which===ESC){editor.val(activeCell.text());e.preventDefault();e.stopPropagation();editor.hide();activeCell.focus()}else if(e.which===TAB){activeCell.focus()}else if(this.selectionEnd-this.selectionStart===this.value.length){let possibleMove=handleMovement(activeCell,e.which);if(possibleMove.length>0){possibleMove.focus();e.preventDefault();e.stopPropagation()}}});editor.on('input paste',function(){let evt=$.Event('validate');activeCell.trigger(evt,editor.val());if(evt.result!==undefined){if(evt.result===!1){editor.addClass(errorClass)}else{editor.removeClass(errorClass)}}});element.on('click keypress dblclick',showEditor).css('cursor','pointer').keydown(function(e){let prevent=!0,possibleMove=handleMovement($(e.target),e.which);if(possibleMove.length>0){possibleMove.focus()}else if(e.which===ENTER){showEditor(!1)}else if(e.which===CONTROL||e.which===LEFT_WINDOWS||e.which===SELECT_KEY){showEditor(!0);prevent=!1}else{prevent=!1}
if(prevent){e.stopPropagation();e.preventDefault()}});element.find('td').prop('tabindex',1);$(window).on('resize',function(){if(editor.is(':visible')){editor.offset(activeCell.offset()).width(activeCell.width()).height(activeCell.height())}});function refresh(){$(element).editableTable(options)}
$('table td').on('validate',function(evt,newValue){let currentColIndex=$(evt.currentTarget).index();let columnDef=options.columns[currentColIndex];let currentData=_instance.getData({convert:!1});let isValid=columnDef.isValid&&columnDef.isValid(newValue,currentData);return isValid});$('table td').on('change',function(evt,newValue){let td=$(this);let currentColIndex=$(evt.currentTarget).index();let columnDef=options.columns[currentColIndex];if(columnDef.removeRowIfCleared&&newValue==''){td.parent('tr').remove()}
if(typeof columnDef.afterChange=='function'){columnDef.afterChange(newValue,td)}
return!0});_instance={getData:function(opts){opts=$.extend({},{convert:!0},opts);let rowData=[];element.find('tbody tr').toArray().forEach(row=>{let newRow={};$(row).find('td').toArray().forEach(col=>{let columnsDef=options.columns[$(col).index()];let value=$(col).text();let isNull=$(col).attr('data-is-null');if(typeof isNull!=='undefined'&&isNull!==!1){value=null}
if(opts.convert&&typeof columnsDef.convertOut=='function'){value=columnsDef.convertOut(value)}
newRow[columnsDef.name]=value});rowData.push(newRow)});return rowData},addRow:function(row){let newRow=$(`<tr></tr>`);if(row!==undefined&&row!==null){let props=Object.keys(row);let columnsToAdd=[];props.forEach(prop=>{let columnDef=options.columns.filter(col=>col.name===prop);if(columnDef.length){columnDef=columnDef[0];columnsToAdd.push({order:columnDef.index,value:row[prop],prop:prop,def:columnDef})}})
columnsToAdd.sort((a,b)=>a.order-b.order).forEach((colToAdd,index)=>{let newCell;if(colToAdd.value!==null)
newCell=$(`<td>${colToAdd.value}</td>`);else newCell=$(`<td data-is-null></td>`);if(colToAdd.def.classes!==undefined&&colToAdd.def.classes.length){colToAdd.def.classes.forEach(classToAdd=>newCell.addClass(classToAdd))}
if(colToAdd.def.style!==undefined&&colToAdd.def.style.length){newCell.attr("style",newCell.attr("style")+"; "+colToAdd.def.style)}
if(colToAdd.def.isHidden!==undefined&&colToAdd.def.isHidden){newCell.hide()}
let columnDef=options.columns.filter(col=>col.name===colToAdd.prop)[0];if(typeof columnDef.afterAdd=='function'){columnDef.afterAdd(colToAdd.value,newCell)}
newRow.append(newCell)})}else{newRow=$(`<tr></tr>`);activeOptions.columns.forEach(x=>{newRow.append(`<td></td>`)})}
let lastRow=element.find('tbody tr:last');if(lastRow.length>0)
lastRow.after(newRow);else element.find('tbody').append(newRow);refresh()},clear:function(){element.find('tbody tr').remove()},setData:function(data){if(data){this.clear();data.forEach(datum=>{this.addRow(datum)})}}};return _instance}
